
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Upgrade Schedule Lookup</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f7f8;
      color: #000;
      padding: 20px;
    }
    h2 {
      color: #002855;
    }
    .note {
      background-color: #e1ecf4;
      border-left: 4px solid #002855;
      padding: 10px;
      margin-bottom: 20px;
    }
    input {
      padding: 8px;
      width: 100%;
      max-width: 400px;
      margin-bottom: 20px;
      font-size: 16px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th {
      background-color: #002855;
      color: white;
      padding: 10px;
      text-align: left;
    }
    td {
      background-color: #ffffff;
      padding: 10px;
      border-bottom: 1px solid #ccc;
    }
    tr:nth-child(even) td {
      background-color: #f1f1f1;
    }
  </style>
</head>
<body>
  <h2>Upgrade Schedule Lookup</h2>
  <div class="note">
    <p>Enter your name or computer ID below to check your upgrade date.<br>
    If you do not see your device, it may already have been upgraded. Please contact Tech Support with questions.</p>
  </div>
  <input type="text" id="search" placeholder="Search by name or computer ID" autofocus />
  <div id="output">Loading...</div>

  <script>
    const SHEET_ID = "13c6BTkvAj8hyE7mQNCU7XNE5_MDkqEsGljyhy4EVGqg";
    const SHEET_GID = "0";  // assuming first tab
    const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${SHEET_GID}`;

    const DATE_COLUMN = "Scheduled Date";

    function formatDate(val) {
      try {
        const d = new Date(val);
        const day = String(d.getDate()).padStart(2, '0');
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const year = d.getFullYear();
        return `${day}/${month}/${year}`;
      } catch {
        return "Not Scheduled";
      }
    }

    fetch(SHEET_URL)
      .then(res => res.text())
      .then(text => {
        const json = JSON.parse(text.substring(47).slice(0, -2));
        const cols = json.table.cols.map(col => col.label);
        const rows = json.table.rows.map(row => row.c.map(c => (c ? c.v : '')));
        const data = rows.map(r => Object.fromEntries(cols.map((col, i) => [col, r[i]])));

        // Only use first 6 columns
        const keys = cols.slice(0, 6);

        data.forEach(row => {
          if (row[DATE_COLUMN] && typeof row[DATE_COLUMN] === "object" && "f" in row[DATE_COLUMN]) {
            row[DATE_COLUMN] = row[DATE_COLUMN].f;
          } else if (row[DATE_COLUMN]) {
            row[DATE_COLUMN] = formatDate(row[DATE_COLUMN]);
          } else {
            row[DATE_COLUMN] = "Not Scheduled";
          }
        });

        window.rawData = data;
        window.headers = keys;
        renderTable();
      })
      .catch(() => {
        document.getElementById("output").innerHTML = "❌ Failed to load data.";
      });

    function renderTable() {
      const input = document.getElementById("search").value.toLowerCase();
      const filtered = window.rawData.filter(row =>
        window.headers.some(key => row[key] && row[key].toString().toLowerCase().includes(input))
      );

      if (filtered.length === 0) {
        document.getElementById("output").innerHTML = "<p>No matches found.</p>";
        return;
      }

      let html = "<table><thead><tr>";
      for (let key of window.headers) html += `<th>${key}</th>`;
      html += "</tr></thead><tbody>";

      for (let row of filtered) {
        html += "<tr>";
        for (let key of window.headers) html += `<td>${row[key] || ''}</td>`;
        html += "</tr>";
      }

      html += "</tbody></table>";
      document.getElementById("output").innerHTML = html;
    }

    document.getElementById("search").addEventListener("input", renderTable);
  </script>
</body>
</html>
