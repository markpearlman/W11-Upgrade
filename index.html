<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Upgrade Schedule Lookup</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background-color: #f6f6f6;
      color: #1a1a1a;
    }
    h2 {
      color: #002855;
    }
    input {
      margin: 10px 0;
      padding: 10px;
      width: 100%;
      max-width: 400px;
      font-size: 1em;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th {
      background-color: #002855;
      color: white;
      padding: 10px;
      text-align: left;
    }
    td {
      background-color: #ffffff;
      border: 1px solid #ccc;
      padding: 10px;
    }
    #output p {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h2>Check Your Windows 11 Upgrade Date</h2>
  <p>Enter your name or computer ID below to find your scheduled upgrade date. If you don’t see your name, your upgrade may have already been completed or is not yet scheduled. Contact IT for help.</p>
  <input type="text" id="search" placeholder="Search by name or computer ID" autofocus>
  <div id="output">Loading...</div>

  <script>
    const SHEET_ID = "13c6BTkvAj8hyE7mQNCU7XNE5_MDkqEsGljyhy4EVGqg";
    const SHEET_NAME = "CleanView";
    const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${SHEET_NAME}&tqx=out:json`;

    let rawData = [];

    fetch(SHEET_URL)
      .then(res => res.text())
      .then(text => {
        const json = JSON.parse(text.substring(47).slice(0, -2));
        const cols = json.table.cols.map(col => col.label);
        const rows = json.table.rows.map(row => row.c.map(c => (c ? c.v : '')));
        rawData = rows.map(r => Object.fromEntries(cols.map((col, i) => [col, r[i]])));
        renderTable();
      })
      .catch(err => {
        document.getElementById("output").innerHTML = "❌ Failed to load data.";
        console.error(err);
      });

    function formatDate(value) {
      if (value instanceof Date) {
        return value.toLocaleDateString();
      }
      if (typeof value === "string" && /^\d{1,2}\/\d{1,2}\/\d{4}$/.test(value)) {
        return value;
      }
      if (typeof value === "string" && /^\d{4}-\d{2}-\d{2}$/.test(value)) {
        return new Date(value).toLocaleDateString();
      }
      if (value && typeof value === "object" && value.hasOwnProperty("f")) {
        return value.f;
      }
      return value || "Not Scheduled";
    }

    function renderTable() {
      const input = document.getElementById("search").value.toLowerCase();
      const filtered = rawData.filter(row =>
        Object.values(row).some(v => v && v.toString().toLowerCase().includes(input))
      );

      if (filtered.length === 0) {
        document.getElementById("output").innerHTML = "<p>No matches found.</p>";
        return;
      }

      const keys = Object.keys(filtered[0]).slice(0, 6); // Only show the first 6 columns
      let html = "<table><tr>" + keys.map(key => `<th>${key}</th>`).join("") + "</tr>";

      for (let row of filtered) {
        html += "<tr>";
        for (let i = 0; i < keys.length; i++) {
          const val = keys[i] === "Scheduled Date" ? formatDate(row[keys[i]]) : row[keys[i]];
          html += `<td>${val}</td>`;
        }
        html += "</tr>";
      }

      html += "</table>";
      document.getElementById("output").innerHTML = html;
    }

    window.onload = () => {
      document.getElementById("search").focus();
    };
  </script>
</body>
</html>
