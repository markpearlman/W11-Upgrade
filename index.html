<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Windows 11 Upgrade Schedule</title>
  <style>
    body {
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      background: #f8f9fa;
      color: #333;
      padding: 40px;
    }
    h2 {
      color: #1b223b;
    }
    #instructions {
      margin-bottom: 15px;
      font-size: 1rem;
      color: #555;
    }
    input {
      padding: 10px;
      width: 300px;
      font-size: 1rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 25px;
    }
    th {
      background-color: #1b223b;
      color: #ffffff;
      font-weight: bold;
      padding: 10px;
      text-align: left;
    }
    td {
      padding: 10px;
      border-top: 1px solid #ddd;
    }
    tr:nth-child(even) td {
      background-color: #f2f2f2;
    }
  </style>
</head>
<body>
  <h2>Windows 11 Upgrade Schedule</h2>
  <div id="instructions">
    Use the box below to search by your name or computer ID to see when your upgrade is scheduled.<br/>
    If you don't see your device, it may have already been upgraded or hasn't been scheduled yet.
  </div>
  <input type="text" id="search" placeholder="Search by name or computer ID" oninput="renderTable()" autofocus />
  <div id="output">Loading...</div>

  <script>
    const SHEET_ID = "13c6BTkvAj8hyE7mQNCU7XNE5_MDkqEsGljyhy4EVGqg";
    const SHEET_NAME = "CleanView";
    const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${SHEET_NAME}&tqx=out:json`;

    let rawData = [];

    fetch(SHEET_URL)
      .then(res => res.text())
      .then(text => {
        const json = JSON.parse(text.substring(47).slice(0, -2));
        const cols = json.table.cols.map(col => col.label);
        const rows = json.table.rows.map(row =>
          row.c.map(c => (c ? c.v : ""))
        );
        rawData = rows.map(r => {
          const rowObject = {};
          cols.forEach((col, i) => {
            let val = r[i];
            if (col === "Scheduled Date") {
              if (!val) {
                val = "Not scheduled";
              } else if (typeof val === "object" && val instanceof Date === false) {
                const d = new Date(val);
                val = (d.getMonth() + 1) + "/" + d.getDate() + "/" + d.getFullYear();
              }
            }
            rowObject[col] = val;
          });
          return rowObject;
        });
        renderTable();
      })
      .catch(err => {
        document.getElementById("output").innerHTML = "âŒ Failed to load data.";
        console.error(err);
      });

    function renderTable() {
      const input = document.getElementById("search").value.toLowerCase();
      const filtered = rawData.filter(row =>
        Object.values(row).some(v =>
          v.toLowerCase().includes(input)
        )
      );

      if (filtered.length === 0) {
        document.getElementById("output").innerHTML = "<p>No matches found.</p>";
        return;
      }

      const keys = Object.keys(filtered[0]).slice(0, 6);  // First 6 columns only
      let html = "<table><tr>";
      keys.forEach(k => {
        html += `<th>${k}</th>`;
      });
      html += "</tr>";

      filtered.forEach(row => {
        html += "<tr>";
        keys.forEach(k => {
          html += `<td>${row[k]}</td>`;
        });
        html += "</tr>";
      });

      html += "</table>";
      document.getElementById("output").innerHTML = html;
    }
  </script>
</body>
</html>
